const screen = document.getElementById("screen");
const modeText = document.getElementById("mode");
const historyList = document.getElementById("historyList");

let exp = "";
let deg = true;

// ---------------- UI ----------------
document.querySelector(".keys").addEventListener("click", e => {
  const b = e.target;
  if (!b.dataset) return;

  if (b.dataset.val) add(b.dataset.val);
  if (b.dataset.fn) trig(b.dataset.fn);
  if (b.dataset.act) action(b.dataset.act);
});

function update(v) {
  screen.textContent = v || "0";
}

// ---------------- BASIC ----------------
function add(v) {
  exp += v;
  update(exp);
}

function action(a) {
  if (a === "clear") {
    exp = "";
    update("0");
  }

  if (a === "back") {
    exp = exp.slice(0, -1);
    update(exp);
  }

  if (a === "mode") {
    deg = !deg;
    modeText.textContent = deg ? "DEG" : "RAD";
  }

  if (a === "equal") calculate();
  if (a === "percent") percent();
  if (a === "power") exp += "^";
}

// ---------------- PERCENT (ANDROID LOGIC) ----------------
function percent() {
  const m = exp.match(/(\d+\.?\d*)$/);
  if (!m) return;

  const num = parseFloat(m[1]);
  const left = exp.slice(0, -m[1].length);

  let baseMatch = left.match(/(\d+\.?\d*)(?=[+\-*\/])$/);
  let base = baseMatch ? parseFloat(baseMatch[1]) : 0;

  let result = base ? (base * num) / 100 : num / 100;
  exp = left + result;
  update(exp);
}

// ---------------- TRIG ----------------
function trig(fn) {
  const m = exp.match(/(\d+\.?\d*)$/);
  if (!m) return;

  const num = parseFloat(m[1]);
  let rad = deg ? num * Math.PI / 180 : num;

  let res =
    fn === "sin" ? Math.sin(rad) :
    fn === "cos" ? Math.cos(rad) :
    Math.tan(rad);

  exp = exp.slice(0, -m[1].length) + res;
  update(exp);
  save(`${fn}(${num}) = ${res}`);
}

// ---------------- POWER + CALC ----------------
function calculate() {
  try {
    let jsExp = exp.replace(/\^/g, "**");
    let result = Function("return " + jsExp)();
    save(`${exp} = ${result}`);
    exp = result.toString();
    update(exp);
  } catch {
    update("Error");
    exp = "";
  }
}

// ---------------- HISTORY ----------------
function save(t) {
  const d = document.createElement("div");
  d.textContent = t;
  historyList.prepend(d);
}

document.getElementById("clearHistory").onclick = () => {
  historyList.innerHTML = "";
};
